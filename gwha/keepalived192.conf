global_defs {
    enable_script_security
    script_user root
}

vrrp_script chk_nginx {
    script "/etc/keepalived/check_nginx.sh"
    interval 2
    # weight -20
}

vrrp_instance vrrp-inst-1 {
    state BACKUP
    nopreempt
    priority 200
    interface enp0s3
    virtual_router_id 101
    unicast_src_ip 192.168.0.192
    unicast_peer { 
        192.168.0.191
    }
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass Test1234
    }
    
    # track_script {
    #     chk_nginx
    # }

    virtual_ipaddress {
        192.168.0.190/24 dev enp0s3
    }

    notify_master "/etc/keepalived/notify_dr.sh MASTER"
    notify_backup "/etc/keepalived/notify_dr.sh BACKUP"
    notify_fault "/etc/keepalived/notify_dr.sh FAULT"
}

virtual_server 192.168.0.190 80 {
    lb_kind DR
    lb_algo wrr
    protocol TCP
    delay_loop 1
    persistence_timeout 6

    real_server 192.168.0.193 80 {
        weight 1
        # inhibit_on_failure
        TCP_CHECK {
            connect_timeout 3
            delay_before_retry 3
            connect_port 80
        }
        
        notify_up "/etc/keepalived/notify_rs.sh 192.168.0.193:80 UP"
        notify_down "/etc/keepalived/notify_rs.sh 192.168.0.193:80 DOWN"
    }
    real_server 192.168.0.194 80 {
        weight 1
        # inhibit_on_failure
        TCP_CHECK {
            connect_timeout 3
            delay_before_retry 3
            connect_port 80
        }

        notify_up "/etc/keepalived/notify_rs.sh 192.168.0.194:80 UP"
        notify_down "/etc/keepalived/notify_rs.sh 192.168.0.194:80 DOWN"
    }
}

virtual_server 192.168.0.190 443 {
    lb_kind DR
    lb_algo wrr
    protocol TCP
    delay_loop 1
    persistence_timeout 6

    real_server 192.168.0.193 443 {
        weight 1
        # inhibit_on_failure
        TCP_CHECK {
            connect_timeout 3
            delay_before_retry 3
            connect_port 443
        }
        
        notify_up "/etc/keepalived/notify_rs.sh 192.168.0.193:443 UP"
        notify_down "/etc/keepalived/notify_rs.sh 192.168.0.193:443 DOWN"
    }
    real_server 192.168.0.194 443 {
        weight 1
        # inhibit_on_failure
        TCP_CHECK {
            connect_timeout 3
            delay_before_retry 3
            connect_port 443
        }

        notify_up "/etc/keepalived/notify_rs.sh 192.168.0.194:443 UP"
        notify_down "/etc/keepalived/notify_rs.sh 192.168.0.194:443 DOWN"
    }
}